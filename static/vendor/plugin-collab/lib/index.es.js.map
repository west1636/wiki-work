{"version":3,"file":"index.es.js","sources":["../src/collab-service.ts","../src/index.ts"],"sourcesContent":["/* Copyright 2021, Milkdown by Mirone. */\nimport type { Ctx } from '@milkdown/ctx'\nimport type { DefaultValue } from '@milkdown/core'\nimport {\n  editorViewCtx,\n  getDoc,\n  parserCtx,\n  prosePluginsCtx,\n  schemaCtx,\n} from '@milkdown/core'\nimport { ctxNotBind, missingYjsDoc } from '@milkdown/exception'\nimport { keydownHandler } from '@milkdown/prose/keymap'\nimport type { Node } from '@milkdown/prose/model'\nimport { Plugin, PluginKey } from '@milkdown/prose/state'\nimport type { DecorationAttrs } from '@milkdown/prose/view'\nimport {\n  prosemirrorToYDoc,\n  redo,\n  undo,\n  yCursorPlugin,\n  yCursorPluginKey,\n  yDocToProsemirror,\n  ySyncPlugin,\n  ySyncPluginKey,\n  yUndoPlugin,\n  yUndoPluginKey,\n} from 'y-prosemirror'\nimport type { Awareness } from 'y-protocols/awareness'\nimport type { Doc, PermanentUserData } from 'yjs'\nimport { applyUpdate, encodeStateAsUpdate } from 'yjs'\n\n/// @internal\nexport interface ColorDef {\n  light: string\n  dark: string\n}\n\n/// @internal\nexport interface YSyncOpts {\n  colors?: Array<ColorDef>\n  colorMapping?: Map<string, ColorDef>\n  permanentUserData?: PermanentUserData | null\n}\n\n/// @internal\nexport interface yCursorOpts {\n  cursorBuilder?: (arg: any) => HTMLElement\n  selectionBuilder?: (arg: any) => DecorationAttrs\n  getSelection?: (arg: any) => any\n}\n\n/// @internal\nexport interface yUndoOpts {\n  protectedNodes?: Set<string>\n  trackedOrigins?: any[]\n  undoManager?: any\n}\n\n/// Options for the collab service.\nexport interface CollabServiceOptions {\n  /// The field name of the yCursor plugin.\n  yCursorStateField?: string\n\n  /// Options for the ySync plugin.\n  ySyncOpts?: YSyncOpts\n\n  /// Options for the yCursor plugin.\n  yCursorOpts?: yCursorOpts\n\n  /// Options for the yUndo plugin.\n  yUndoOpts?: yUndoOpts\n}\n\n/// @internal\nexport const CollabKeymapPluginKey = new PluginKey('MILKDOWN_COLLAB_KEYMAP')\n\nconst collabPluginKeys = [CollabKeymapPluginKey, ySyncPluginKey, yCursorPluginKey, yUndoPluginKey]\n\n/// The collab service is used to manage the collaboration plugins.\n/// It is used to provide the collaboration plugins to the editor.\nexport class CollabService {\n  /// @internal\n  #options: CollabServiceOptions = {}\n  /// @internal\n  #doc: Doc | null = null\n  /// @internal\n  #awareness: Awareness | null = null\n  /// @internal\n  #ctx: Ctx | null = null\n  /// @internal\n  #connected = false\n\n  /// @internal\n  #valueToNode(value: DefaultValue): Node | undefined {\n    if (!this.#ctx)\n      throw ctxNotBind()\n\n    const schema = this.#ctx.get(schemaCtx)\n    const parser = this.#ctx.get(parserCtx)\n\n    const doc = getDoc(value, parser, schema)\n    return doc\n  }\n\n  /// @internal\n  #createPlugins(): Plugin[] {\n    if (!this.#doc)\n      throw missingYjsDoc()\n    const { ySyncOpts, yUndoOpts } = this.#options\n    const type = this.#doc.getXmlFragment('prosemirror')\n    const plugins = [\n      ySyncPlugin(type, ySyncOpts),\n      yUndoPlugin(yUndoOpts),\n      new Plugin({\n        key: CollabKeymapPluginKey,\n        props: {\n          handleKeyDown: keydownHandler({\n            'Mod-z': undo,\n            'Mod-y': redo,\n            'Mod-Shift-z': redo,\n          }),\n        },\n      }),\n    ]\n    if (this.#awareness) {\n      const { yCursorOpts, yCursorStateField } = this.#options\n      plugins.push(yCursorPlugin(this.#awareness, yCursorOpts as Required<yCursorOpts>, yCursorStateField))\n    }\n\n    return plugins\n  }\n\n  /// @internal\n  #flushEditor(plugins: Plugin[]) {\n    if (!this.#ctx)\n      throw ctxNotBind()\n    this.#ctx.set(prosePluginsCtx, plugins)\n\n    const view = this.#ctx.get(editorViewCtx)\n    const newState = view.state.reconfigure({ plugins })\n    view.updateState(newState)\n  }\n\n  /// Bind the context to the service.\n  bindCtx(ctx: Ctx) {\n    this.#ctx = ctx\n    return this\n  }\n\n  /// Bind the document to the service.\n  bindDoc(doc: Doc) {\n    this.#doc = doc\n    return this\n  }\n\n  /// Set the options of the service.\n  setOptions(options: CollabServiceOptions) {\n    this.#options = options\n    return this\n  }\n\n  /// Merge some options to the service.\n  /// The options will be merged to the existing options.\n  /// THe options should be partial of the `CollabServiceOptions`.\n  mergeOptions(options: Partial<CollabServiceOptions>) {\n    Object.assign(this.#options, options)\n    return this\n  }\n\n  /// Set the awareness of the service.\n  setAwareness(awareness: Awareness) {\n    this.#awareness = awareness\n    return this\n  }\n\n  /// Apply the template to the document.\n  applyTemplate(template: DefaultValue, condition?: (yDocNode: Node, templateNode: Node) => boolean) {\n    if (!this.#ctx)\n      throw ctxNotBind()\n    if (!this.#doc)\n      throw missingYjsDoc()\n    const conditionFn = condition || (yDocNode => yDocNode.textContent.length === 0)\n\n    const node = this.#valueToNode(template)\n    const schema = this.#ctx.get(schemaCtx)\n    const yDocNode = yDocToProsemirror(schema, this.#doc)\n\n    if (node && conditionFn(yDocNode, node)) {\n      const fragment = this.#doc.getXmlFragment('prosemirror')\n      fragment.delete(0, fragment.length)\n      const templateDoc = prosemirrorToYDoc(node)\n      const template = encodeStateAsUpdate(templateDoc)\n      applyUpdate(this.#doc, template)\n      templateDoc.destroy()\n    }\n\n    return this\n  }\n\n  /// Connect the service.\n  connect() {\n    if (!this.#ctx)\n      throw ctxNotBind()\n    if (this.#connected)\n      return\n\n    const prosePlugins = this.#ctx.get(prosePluginsCtx)\n    const collabPlugins = this.#createPlugins()\n    const plugins = prosePlugins.concat(collabPlugins)\n\n    this.#flushEditor(plugins)\n    this.#connected = true\n\n    return this\n  }\n\n  /// Disconnect the service.\n  disconnect() {\n    if (!this.#ctx)\n      throw ctxNotBind()\n    if (!this.#connected)\n      return this\n\n    const prosePlugins = this.#ctx.get(prosePluginsCtx)\n    const plugins = prosePlugins.filter(\n      plugin => !plugin.spec.key || !collabPluginKeys.includes(plugin.spec.key),\n    )\n\n    this.#flushEditor(plugins)\n    this.#connected = false\n\n    return this\n  }\n}\n","/* Copyright 2021, Milkdown by Mirone. */\nimport type { MilkdownPlugin } from '@milkdown/ctx'\nimport { createSlice, createTimer } from '@milkdown/ctx'\nimport { EditorViewReady } from '@milkdown/core'\n\nimport { CollabService } from './collab-service'\n\n/// A slice that contains the collab service.\nexport const collabServiceCtx = createSlice(new CollabService(), 'collabServiceCtx')\n\n/// The timer that indicates the collab plugin is ready.\nexport const CollabReady = createTimer('CollabReady')\n\n/// The collab plugin.\nexport const collab: MilkdownPlugin = (ctx) => {\n  const collabService = new CollabService()\n  ctx.inject(collabServiceCtx, collabService).record(CollabReady)\n  return async () => {\n    await ctx.wait(EditorViewReady)\n    collabService.bindCtx(ctx)\n    ctx.done(CollabReady)\n    return () => {\n      ctx.remove(collabServiceCtx).clearTimer(CollabReady)\n    }\n  }\n}\ncollab.meta = {\n  package: '@milkdown/plugin-collab',\n  displayName: 'Collab',\n}\n\nexport * from './collab-service'\n"],"names":["CollabKeymapPluginKey","PluginKey","collabPluginKeys","ySyncPluginKey","yCursorPluginKey","yUndoPluginKey","CollabService","__privateAdd","_valueToNode","_createPlugins","_flushEditor","_options","_doc","_awareness","_ctx","_connected","ctx","__privateSet","doc","options","__privateGet","awareness","template","condition","ctxNotBind","missingYjsDoc","conditionFn","yDocNode","node","__privateMethod","valueToNode_fn","schema","schemaCtx","yDocToProsemirror","fragment","templateDoc","prosemirrorToYDoc","encodeStateAsUpdate","applyUpdate","prosePlugins","prosePluginsCtx","collabPlugins","createPlugins_fn","plugins","flushEditor_fn","plugin","value","parser","parserCtx","getDoc","ySyncOpts","yUndoOpts","type","ySyncPlugin","yUndoPlugin","Plugin","keydownHandler","undo","redo","yCursorOpts","yCursorStateField","yCursorPlugin","view","editorViewCtx","newState","collabServiceCtx","createSlice","CollabReady","createTimer","collab","collabService","EditorViewReady"],"mappings":"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"}